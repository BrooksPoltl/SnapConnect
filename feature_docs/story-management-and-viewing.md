# Revised Feature Plan: Story Management

This plan outlines the remaining tasks to allow users to view analytics for and
delete their own stories.

### Backend

| Priority | Task Description                           | Implementation Details                                                                                                                                                                                                                                                                                                        | Code Pointers (Proposed)          | Dependencies                     | Status  |
| :------- | :----------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------- | :------------------------------- | :------ |
| **High** | **Create `delete_story` DB Function**      | Create a `SECURITY DEFINER` RPC function, `delete_story(p_story_id BIGINT)`, that verifies the caller is the story's author. The function must atomically delete the record from `public.stories` (which will cascade to `story_views`) and remove the associated media file from Supabase Storage to prevent orphaned files. | `supabase/migrations/` (new file) | `stories`, `story_views` tables  | ☐ To Do |
| **High** | **Create `get_story_viewers` DB Function** | Create an RPC function, `get_story_viewers(p_story_id BIGINT)`, that returns the total view count and a list of viewers (joining `story_views` and `profiles`). This function must be secured with RLS or explicit checks to ensure only the story's author can call it.                                                      | `supabase/migrations/` (new file) | `story_views`, `profiles` tables | ☐ To Do |

### Frontend

| Priority | Task Description                 | Implementation Details                                                                                                                                                                                                                                                                                                                                                             | Code Pointers (Proposed)                                  | Dependencies      | Status  |
| :------- | :------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------- | :---------------- | :------ |
| **High** | **Update Story Types**           | Create a `StoryViewer` type (`username`, `user_id`, `viewed_at`). Create a `MyStoryAnalytics` type to hold the `view_count` and the `viewers: StoryViewer[]` array returned from the new backend function.                                                                                                                                                                         | `src/types/stories.ts`                                    | Backend Changes   | ☐ To Do |
| **High** | **Update `stories` Service**     | Add `deleteStory(storyId)` and `getStoryViewers(storyId)` functions to the service to call the new backend RPCs.                                                                                                                                                                                                                                                                   | `src/services/stories.ts`                                 | Backend RPCs      | ☐ To Do |
| **High** | **Update `StoriesScreen` UI**    | Modify the user's own story circle component to navigate to `MyStoryViewerScreen` when tapped. The `all_stories_viewed` flag from `get_stories_feed` can now be used to apply a "viewed" style (e.g., a gray border).                                                                                                                                                              | `src/screens/StoriesScreen/index.tsx`                     | Updated Types     | ☐ To Do |
| **High** | **Create `MyStoryViewerScreen`** | Create a new screen for story owners. It will: 1. Display story content with navigation between the user's own stories. 2. Have a prominent "Delete" button with a confirmation dialog that calls the `deleteStory` service. 3. Contain a UI element (e.g., "Viewers") that, on tap, fetches analytics using `getStoryViewers` and displays the list of viewers in a bottom sheet. | `src/screens/MyStoryViewerScreen/`                        | `stories` Service | ☐ To Do |
| **High** | **Update Navigation**            | Add `MyStoryViewerScreen` to the `UserStack`. Update `StoriesScreen` navigation logic to route to `MyStoryViewerScreen` if the user is the story's author.                                                                                                                                                                                                                         | `src/navigation/UserStack.tsx`, `src/types/navigation.ts` | New Screen        | ☐ To Do |
